# 实现连接池诊断与管理UI

## 1. 问题分析
用户遇到的主要问题是连接池连接获取超时，具体表现为：
- `Connection acquisition timed out for session metadata_extractor_6ced733d`
- `Query execution failed: Query timeout after 30 seconds`

这些错误表明连接池可能存在以下问题：
1. 连接池资源耗尽
2. 连接被长时间占用未释放
3. 连接池配置不合理
4. 数据库连接本身存在问题

## 2. 实现计划

### 2.1 创建连接池诊断模板文件
- 创建 `doris_mcp_server/templates/db_templates.py` 文件
- 设计连接池诊断页面，包含：
  - **连接池基本信息**：大小、活跃连接数、空闲连接数、最大连接数
  - **连接池状态**：健康状态、最后健康检查时间
  - **连接池指标**：失败连接数、错误数、平均连接时间
  - **会话详情**：当前活跃会话列表、每个会话的连接状态
  - **锁信息**：连接池锁状态、会话锁持有情况
  - **超时诊断**：连接获取超时统计、查询超时统计
  - **操作按钮**：
    - 测试连接
    - 刷新状态
    - 释放空闲连接
    - 强制关闭所有连接
    - **强制重建连接池**

### 2.2 创建连接池诊断处理程序
- 创建 `doris_mcp_server/auth/db_handlers.py` 文件
- 实现以下功能：
  - `handle_db_management_page`: 显示连接池管理和诊断页面
  - `handle_get_db_status`: 获取详细连接池状态JSON数据
  - `handle_test_connection`: 测试数据库连接
  - `handle_refresh_pool`: 刷新连接池
  - `handle_close_idle_connections`: 释放空闲连接
  - `handle_close_all_connections`: 强制关闭所有连接
  - `handle_recreate_pool`: 强制重建连接池

### 2.3 增强连接池监控功能
- 在 `DorisConnectionManager` 类中添加会话监控功能
- 记录每个连接的会话ID、创建时间、最后使用时间
- 添加连接获取超时统计
- 添加查询执行超时统计
- 实现 `get_session_details()` 方法，返回所有活跃会话详情

### 2.4 集成到主应用
- 在 `doris_mcp_server/main.py` 中添加连接池相关路由
- 更新导航菜单，添加连接池管理链接
- 添加以下API端点：
  - `/db/status`: 获取连接池状态JSON
  - `/db/test`: 测试数据库连接
  - `/db/refresh`: 刷新连接池
  - `/db/close-idle`: 释放空闲连接
  - `/db/close-all`: 强制关闭所有连接
  - `/db/recreate`: 强制重建连接池

### 2.5 实现连接池超时诊断功能
- 添加连接获取超时的原因分析
- 显示当前等待连接的请求队列
- 提供连接池配置建议
- 显示连接池锁状态

## 3. 技术细节

### 3.1 UI设计
- 采用卡片布局展示不同类别的信息
- 使用实时更新功能，自动刷新连接池状态
- 显示连接获取超时的详细统计
- 为每个会话显示连接状态、使用时长、最后查询时间
- 为操作按钮添加确认对话框
- 提供连接池配置优化建议

### 3.2 后端实现
- 增强 `DorisConnectionManager` 类，添加会话监控
- 实现 `close_idle_connections()` 方法，释放长时间空闲的连接
- 实现 `close_all_connections()` 方法，强制关闭所有连接
- 实现 `recreate_pool()` 方法，强制重建连接池
- 添加连接获取超时统计和分析

### 3.3 诊断功能
- 分析连接池使用情况，识别资源瓶颈
- 显示连接获取等待队列
- 提供连接池配置优化建议
- 显示会话锁持有情况
- 提供连接泄漏检测

## 4. 预期效果
- 用户可以通过UI实时查看连接池的详细状态
- 可以查看所有活跃会话的详细信息
- 可以诊断连接获取超时的原因
- 可以通过操作按钮解决连接池问题
- 获得连接池配置优化建议
- 能够强制重建连接池来解决严重问题

## 5. 文件变更
- `doris_mcp_server/templates/db_templates.py` (新增)
- `doris_mcp_server/auth/db_handlers.py` (新增)
- `doris_mcp_server/main.py` (修改)
- `doris_mcp_server/utils/db.py` (修改，增强会话监控和连接管理)
- `doris_mcp_server/auth/index_handlers.py` (修改)

## 6. 重点功能

### 6.1 连接池状态监控
- 显示连接池的详细指标
- 显示活跃会话列表和状态
- 显示连接获取超时统计
- 显示连接池锁状态

### 6.2 会话管理
- 显示每个会话的连接详情
- 显示会话的查询历史
- 提供会话级别的连接释放功能

### 6.3 连接池操作
- 测试连接：验证数据库连接是否正常
- 刷新状态：立即更新连接池状态
- 释放空闲连接：释放长时间未使用的连接
- 强制关闭所有连接：关闭所有连接并重新创建
- **强制重建连接池**：彻底关闭连接池并重新初始化

### 6.4 诊断与建议
- 连接获取超时原因分析
- 连接池配置优化建议
- 连接泄漏检测
- 锁竞争分析

## 7. 测试计划
- 测试连接池状态监控功能
- 测试会话详情显示
- 测试连接获取超时诊断
- 测试连接池操作功能
- 测试连接池重建功能
- 测试权限控制

## 8. 安全考虑
- 所有连接池管理API都需要身份验证
- 限制连接池操作权限
- 添加操作日志记录
- 强制重建连接池操作需要额外确认